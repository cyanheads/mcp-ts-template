# Migration Guide: Upgrading to v1.9.0

**Version:** 1.9.0
**Date:** 2025-08-23

This guide provides detailed instructions for migrating an existing project based on the `mcp-ts-template` to version 1.9.0. This version introduces significant architectural improvements focused on simplifying development, enhancing traceability, and standardizing core functionalities.

## Table of Contents

1.  [**Key Architectural Changes**](#key-architectural-changes)
2.  [**Step-by-Step Migration**](#step-by-step-migration)
    - [Updating Dependencies](#1-updating-dependencies)
    - [Updating `tsconfig.json` for Path Aliases](#2-updating-tsconfigjson-for-path-aliases)
    - [Refactoring the Logger](#3-refactoring-the-logger)
    - [Adopting AsyncLocalStorage for Context Management](#4-adopting-asynclocalstorage-for-context-management)
    - [Refactoring Tool & Resource Handlers](#5-refactoring-tool--resource-handlers)
    - [Updating Error Codes](#6-updating-error-codes)
    - [Updating Server Initialization](#7-updating-server-initialization)
3.  [**Conclusion**](#conclusion)

---

## Key Architectural Changes

Version 1.9.0 introduces several major enhancements:

1.  **AsyncLocalStorage for Request Context**: We have replaced manual "prop drilling" of the `RequestContext` with Node.js's `AsyncLocalStorage`. This means the context is now implicitly available throughout the entire asynchronous call stack of an operation, dramatically simplifying function signatures in the logic layer.
2.  **Centralized Tool & Resource Handlers**: The `try...catch` blocks, performance measurement, and response formatting logic have been extracted from individual `registration.ts` files into centralized `createToolHandler` and `createResourceHandler` utilities. This reduces boilerplate and ensures consistent behavior across all tools and resources.
3.  **Pino Logger Implementation**: The logging system has been migrated from Winston to Pino for improved performance and structured logging. New helper functions (`logOperationStart`, `logOperationSuccess`, etc.) are introduced to standardize log messages.
4.  **Standardized JSON-RPC Error Codes**: The custom `BaseErrorCode` enum has been replaced with `JsonRpcErrorCode`, which aligns with the JSON-RPC 2.0 specification for better interoperability.
5.  **TypeScript Path Aliases**: The project now uses path aliases (e.g., `@/utils`) defined in `tsconfig.json` to simplify import statements and improve code readability.

## Step-by-Step Migration

### 1. Updating Dependencies

Update your `package.json` to match the new dependencies in v1.9.0. Key changes include:

- **Added**: `pino`, `pino-pretty`, `pino-roll`, `ts-node`, `tsc-alias`, `chalk`, `execa`.
- **Removed**: `winston`, `winston-transport`, `@opentelemetry/instrumentation-winston`.
- **Updated**: `@modelcontextprotocol/sdk`, `@supabase/supabase-js`, and various development dependencies.

Run `npm install` to apply the changes.

### 2. Updating `tsconfig.json` for Path Aliases

Add the `baseUrl` and `paths` compiler options to your `tsconfig.json` to enable path aliases. This is crucial for the new import structure.

**`tsconfig.json`**

```json
{
  "compilerOptions": {
    // ... other options
    "module": "NodeNext",
    "moduleResolution": "NodeNext",

    // Add these path aliases
    "baseUrl": "./src",
    "paths": {
      "@/types-global/*": ["types-global/*"],
      "@/utils/*": ["utils/*"],
      "@/utils": ["utils/index"],
      "@/services/*": ["services/*"],
      "@/mcp-server/*": ["mcp-server/*"],
      "@/*": ["*"]
    },

    "strict": true
    // ... other options
  }
}
```

### 3. Refactoring the Logger

The `winston`-based logger has been replaced with a pre-configured `pino` instance.

- **Remove Logger Initialization**: Delete any calls to `logger.initialize()`. The new logger is ready for use immediately upon import.
- **Update Logging Calls**: Replace old logger calls with the new helper functions or direct `pino` methods.

**Before (`src/index.ts`):**

```typescript
import { logger, McpLogLevel } from "./utils/internal/logger.js";
// ...
await logger.initialize(validatedMcpLogLevel);
logger.info("Logger initialized.");
```

**After (`src/index.ts`):**

```typescript
import { logOperationStart } from "@/utils/internal/logging-helpers.js";
// ...
// No initialization needed.
logOperationStart(startupContext, "Starting server...");
```

### 4. Adopting AsyncLocalStorage for Context Management

This is the most significant change. `RequestContext` is no longer passed as a parameter to logic functions.

- **Update Function Signatures**: Remove the `context: RequestContext` parameter from all your tool and resource `logic.ts` functions.
- **Retrieve Context**: Inside your logic functions, use the `getRequestContext()` utility to retrieve the active context.

**Before (`echoTool/logic.ts`):**

```typescript
export async function echoToolLogic(
  params: EchoToolInput,
  context: RequestContext, // <-- This is removed
): Promise<EchoToolResponse> {
  logger.debug("Processing logic.", { ...context, toolInput: params });
  // ...
}
```

**After (`echoTool/logic.ts`):**

```typescript
import { getRequestContext } from "../../../utils/index.js";

export async function echoToolLogic(
  params: EchoToolInput,
): Promise<EchoToolResponse> {
  const context = getRequestContext(); // <-- Get context here
  logger.debug({ ...context, toolInput: params }, "Processing logic.");
  // ...
}
```

### 5. Refactoring Tool & Resource Handlers

All handler logic is now centralized. Your `registration.ts` files will become much simpler.

- **Create Utility Files**: Create `src/mcp-server/tools/utils/tool-utils.ts` and `src/mcp-server/resources/utils/resource-utils.ts` and copy the content from the v1.9.0 template.
- **Refactor Registration**: Update your `registration.ts` files to use the new `createToolHandler` and `createResourceHandler` utilities.

**Before (`echoTool/registration.ts`):**

```typescript
// ... imports
export const registerEchoTool = async (server: McpServer): Promise<void> => {
  // ... registration context setup
  await ErrorHandler.tryCatch(
    async () => {
      server.registerTool(
        TOOL_NAME,
        {
          /* ...spec... */
        },
        async (params: EchoToolInput, callContext: Record<string, unknown>) => {
          const handlerContext = requestContextService.createRequestContext({
            /*...*/
          });
          try {
            const result = await measureToolExecution(
              () => echoToolLogic(params, handlerContext),
              { ...handlerContext, toolName: TOOL_NAME },
              params,
            );
            return {
              /* ...success response... */
            };
          } catch (error) {
            const mcpError = ErrorHandler.handleError(error, {
              /*...*/
            });
            return {
              /* ...error response... */
            };
          }
        },
      );
    },
    {
      /* ...error handler options... */
    },
  );
};
```

**After (`echoTool/registration.ts`):**

```typescript
import { createToolHandler, ResponseFormatter } from "../utils/tool-utils.js";
import { echoToolLogic, EchoToolResponse, ... } from "./logic.js";

// 1. Define a response formatter
const responseFormatter: ResponseFormatter<EchoToolResponse> = (result) => ({
  structuredContent: result,
  content: [{ type: "text", text: `Success: ${JSON.stringify(result, null, 2)}` }],
});

export const registerEchoTool = async (server: McpServer): Promise<void> => {
  // ... registration context setup
  await ErrorHandler.tryCatch(
    async () => {
      server.registerTool(
        TOOL_NAME,
        { /* ...spec... */ },
        // 2. Use the centralized handler
        createToolHandler(TOOL_NAME, echoToolLogic, responseFormatter),
      );
      // ...
    },
    { /* ...error handler options... */ }
  );
};
```

### 6. Updating Error Codes

Replace all instances of `BaseErrorCode` with the new `JsonRpcErrorCode` enum. The new enum uses standard numerical codes.

**Before:**

```typescript
import { BaseErrorCode, McpError } from "../../../types-global/errors.js";
throw new McpError(BaseErrorCode.VALIDATION_ERROR, "Invalid input.");
```

**After:**

```typescript
import { JsonRpcErrorCode, McpError } from "../../../types-global/errors.js";
throw new McpError(JsonRpcErrorCode.ValidationError, "Invalid input.");
```

### 7. Updating Server Initialization

The server startup process in `server.ts` now uses centralized `registerAllTools` and `registerAllResources` functions.

- **Create Barrel Files**: Create `src/mcp-server/tools/index.ts` and `src/mcp-server/resources/index.ts`. Copy the content from the v1.9.0 template. These files import all individual registration functions and export a single `registerAll` function.
- **Update `server.ts`**: Modify `createMcpServerInstance` to call these new functions.

**Before (`server.ts`):**

```typescript
// ...
import { registerEchoTool } from "./tools/echoTool/index.js";
import { registerCatFactFetcherTool } from "./tools/catFactFetcher/index.js";
// ...

async function createMcpServerInstance(): Promise<ManagedMcpServer> {
  // ...
  await registerEchoTool(server);
  await registerCatFactFetcherTool(server);
  // ...
}
```

**After (`server.ts`):**

```typescript
// ...
import { registerAllResources } from "@/mcp-server/resources/index.js";
import { registerAllTools } from "@/mcp-server/tools/index.js";
// ...

async function createMcpServerInstance(): Promise<McpServer> {
  // ...
  await registerAllResources(server);
  await registerAllTools(server);
  // ...
}
```

---

## Conclusion

The migration to v1.9.0 requires several significant but beneficial refactoring steps. By centralizing logic, simplifying context management, and standardizing logging and errors, your MCP server will be more robust, maintainable, and easier to extend. Please review the changes in the template carefully and apply them to your project.
